================================================================================
FIELDCHECK - IMPLEMENTATION GUIDE FOR NEW FEATURES
================================================================================

This document provides a comprehensive guide for implementing the new features
added to the FieldCheck system, including PDF/Excel export functionality and
polygon geofencing support.

================================================================================
1. PDF/EXCEL EXPORT FUNCTIONALITY
================================================================================

1.1 BACKEND IMPLEMENTATION

New Files Created:
- backend/services/reportExportService.js
- backend/controllers/exportController.js
- backend/routes/exportRoutes.js

Dependencies Added to package.json:
- "pdfkit": "^0.13.0" - PDF generation library
- "exceljs": "^4.3.0" - Excel file generation library

Installation:
1. Navigate to the backend directory:
   cd backend

2. Install the new dependencies:
   npm install pdfkit exceljs

3. The export routes are already integrated in server.js

API Endpoints Available:

GET /api/export/attendance/pdf
- Export attendance records as PDF
- Query Parameters:
  - startDate: ISO date format (optional)
  - endDate: ISO date format (optional)
  - employeeId: Employee ID (optional)
  - geofenceId: Geofence ID (optional)
- Response: PDF file download

GET /api/export/attendance/excel
- Export attendance records as Excel
- Query Parameters: Same as PDF endpoint
- Response: Excel file download

GET /api/export/tasks/pdf
- Export tasks as PDF
- Query Parameters:
  - startDate: ISO date format (optional)
  - endDate: ISO date format (optional)
  - status: Task status filter (optional)
- Response: PDF file download

GET /api/export/tasks/excel
- Export tasks as Excel
- Query Parameters: Same as PDF endpoint
- Response: Excel file download

GET /api/export/combined/excel
- Export combined report (attendance + tasks) as Excel
- Query Parameters:
  - startDate: ISO date format (optional)
  - endDate: ISO date format (optional)
- Response: Excel file download

1.2 MOBILE APP IMPLEMENTATION

New File Created:
- field_check/lib/services/export_service.dart

Dependencies to Add to pubspec.yaml:
- path_provider: ^2.0.0 (for file storage)

Installation:
1. Add to pubspec.yaml:
   path_provider: ^2.0.0

2. Run:
   flutter pub get

Usage Example in Flutter:
```dart
import 'package:field_check/services/export_service.dart';

final exportService = ExportService();

// Export attendance as PDF
try {
  final filePath = await exportService.exportAttendancePDF(
    startDate: '2025-01-01',
    endDate: '2025-01-31',
  );
  print('PDF saved to: $filePath');
} catch (e) {
  print('Error: $e');
}

// Export attendance as Excel
try {
  final filePath = await exportService.exportAttendanceExcel(
    startDate: '2025-01-01',
    endDate: '2025-01-31',
  );
  print('Excel saved to: $filePath');
} catch (e) {
  print('Error: $e');
}

// Export combined report
try {
  final filePath = await exportService.exportCombinedExcel(
    startDate: '2025-01-01',
    endDate: '2025-01-31',
  );
  print('Combined report saved to: $filePath');
} catch (e) {
  print('Error: $e');
}
```

1.3 ADMIN DASHBOARD INTEGRATION

To integrate export functionality in the admin dashboard:

1. Add export buttons to the reports screen
2. Call the export endpoints with appropriate filters
3. Handle file downloads in the browser

Example JavaScript/React code:
```javascript
const exportAttendancePDF = async (filters) => {
  const params = new URLSearchParams(filters);
  const response = await fetch(`/api/export/attendance/pdf?${params}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  if (response.ok) {
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance_${Date.now()}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
  }
};
```

================================================================================
2. POLYGON GEOFENCING SUPPORT
================================================================================

2.1 BACKEND IMPLEMENTATION

Polygon geofencing uses the Ray Casting algorithm to determine if a point
(employee's GPS coordinates) is inside a polygon (geofence boundary).

Algorithm Overview:
1. Cast a ray from the point to infinity
2. Count how many times the ray intersects the polygon edges
3. If count is odd, point is inside; if even, point is outside

Implementation Steps:

1. Update Geofence Model (models/Geofence.js):
   - Add support for polygon coordinates array
   - Add shape type field (circle or polygon)

2. Create Polygon Validation Function:
```javascript
// Point-in-polygon using ray casting algorithm
function isPointInPolygon(point, polygon) {
  const { lat, lng } = point;
  let inside = false;

  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i].lat, yi = polygon[i].lng;
    const xj = polygon[j].lat, yj = polygon[j].lng;

    const intersect = ((yi > lng) !== (yj > lng))
      && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }

  return inside;
}
```

3. Update Geofence Service to support polygon validation

4. Update Attendance Check-in Endpoint:
   - Detect geofence shape type
   - Use appropriate validation algorithm

2.2 MOBILE APP IMPLEMENTATION

Update Flutter Geofence Model:
```dart
enum GeofenceShape { circle, polygon }

class Geofence {
  final String id;
  final String name;
  final double latitude;
  final double longitude;
  final double radius;
  final GeofenceShape shape;
  final List<Map<String, double>>? polygonCoordinates; // For polygon geofences
  // ... other fields
}
```

Update Geofence Service:
```dart
bool isLocationWithinPolygon(double lat, double lng, List<Map<String, double>> polygon) {
  bool inside = false;
  
  for (int i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    final xi = polygon[i]['lat']!;
    final yi = polygon[i]['lng']!;
    final xj = polygon[j]['lat']!;
    final yj = polygon[j]['lng']!;

    final intersect = ((yi > lng) != (yj > lng))
        && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  
  return inside;
}
```

2.3 ADMIN DASHBOARD IMPLEMENTATION

Add Polygon Drawing Tool:
1. Use a web mapping library (Leaflet with Leaflet Draw, Mapbox, or similar) for polygon drawing
2. Capture polygon coordinates when user completes drawing
3. Send coordinates to backend when creating/updating geofence

Example (Using Leaflet Draw for web admin dashboard):
```javascript
// Using Leaflet Draw
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

const drawControl = new L.Control.Draw({
  draw: {
    polygon: true,
    polyline: false,
    rectangle: false,
    circle: false,
    marker: false
  }
});
map.addControl(drawControl);

map.on('draw:created', function(e) {
  const layer = e.layer;
  const coordinates = layer.getLatLngs();
  // Send coordinates to backend
});
```

Note: For the mobile app (Flutter), use flutter_map with custom drawing tools or plugins
to capture polygon coordinates on the map interface.

================================================================================
3. TESTING THE NEW FEATURES
================================================================================

3.1 BACKEND TESTING

Test Export Endpoints:
1. Use Postman or curl to test export endpoints
2. Verify PDF and Excel files are generated correctly
3. Test with various filter combinations

Example curl commands:
```bash
# Export attendance PDF
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:3000/api/export/attendance/pdf?startDate=2025-01-01&endDate=2025-01-31" \
  -o attendance.pdf

# Export attendance Excel
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:3000/api/export/attendance/excel?startDate=2025-01-01&endDate=2025-01-31" \
  -o attendance.xlsx
```

3.2 MOBILE APP TESTING

Test Export Service:
1. Create a test screen with export buttons
2. Call export methods with test data
3. Verify files are saved to device storage
4. Test file retrieval and deletion

3.3 POLYGON GEOFENCING TESTING

Test Point-in-Polygon Algorithm:
1. Create test polygons with known coordinates
2. Test points inside, outside, and on boundaries
3. Verify accuracy with various polygon shapes
4. Test with real GPS data

================================================================================
4. DEPLOYMENT CHECKLIST
================================================================================

Before deploying to production:

Backend:
[ ] Install new dependencies (pdfkit, exceljs)
[ ] Test all export endpoints
[ ] Verify file generation and download
[ ] Test with large datasets
[ ] Monitor memory usage during export
[ ] Set up error logging

Mobile App:
[ ] Add path_provider dependency
[ ] Test export functionality on both iOS and Android
[ ] Verify file storage and retrieval
[ ] Test with various file sizes
[ ] Test file sharing functionality

Admin Dashboard:
[ ] Integrate export buttons in UI
[ ] Test file downloads in different browsers
[ ] Verify filter parameters are passed correctly
[ ] Add loading indicators during export

General:
[ ] Update API documentation
[ ] Update user guides
[ ] Conduct user acceptance testing
[ ] Prepare deployment plan
[ ] Create backup of current system

================================================================================
5. FUTURE ENHANCEMENTS
================================================================================

Polygon Geofencing:
- Support for complex polygons with holes
- Geofence visualization on mobile app
- Geofence editing tools in admin dashboard
- Performance optimization for large polygons

Export Functionality:
- Scheduled report generation
- Email report delivery
- Advanced filtering options
- Custom report templates
- Data visualization in exports

================================================================================
6. TROUBLESHOOTING
================================================================================

Common Issues:

Issue: PDF export fails with memory error
Solution: Implement pagination for large datasets, process in chunks

Issue: Excel file is corrupted
Solution: Verify ExcelJS version compatibility, check file writing permissions

Issue: Polygon geofencing is inaccurate
Solution: Verify coordinate format, test algorithm with known test cases

Issue: Export takes too long
Solution: Implement background job processing, add caching for frequently exported data

================================================================================
7. SUPPORT AND MAINTENANCE
================================================================================

For issues or questions:
1. Check the troubleshooting section above
2. Review the implementation guide
3. Contact the development team
4. Submit bug reports with detailed information

Maintenance Tasks:
- Monitor export functionality performance
- Update dependencies regularly
- Review and optimize geofencing algorithms
- Gather user feedback for improvements

================================================================================
END OF IMPLEMENTATION GUIDE
================================================================================
